@using Microsoft.EntityFrameworkCore.Metadata.Internal
@{
    ViewData["Titlex"] = ViewBag.DbSetName;
    Layout = "_CrispyAdminLayout";
}
<div class="card">
    <div class="card-header">
        <h5>@ViewBag.DbSetName - Create </h5>
        <p class="mb-0">| @ViewBag.DbSetName form details </p>
    </div>

    <div class="card-body">
        <div class="modal" id="filemanagermodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                <div class="modal-content" style="height:550px">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalCenterTitle">File Manager</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body clearfix" id="file-manager-modal">
                    </div>
                </div>
            </div>
        </div>
        <form class="form theme-form" asp-controller="CrispyAdminData" asp-action="CreateEntityPost" method="post" asp-route-languageId="@ViewBag.LanguageId" asp-route-dbSetName="@ViewBag.DbSetName">
            <div class="card-body">
                @Html.Hidden("dbSetName", ViewBag.DbSetName, new {})
                @Html.EditorForModel("DefaultEntity",new { relatedDropdowns = ViewBag.RelatedDropdowns , multiselectRelatedDropdowns = ViewBag.MultiselectRelatedDropdowns})
            </div>
            @* <div class="card-body"> *@
            @*     <h6>SEO Ayarları</h6> *@
            @*     <div class="form-group row"> *@
            @*         <label class="col-sm-3 col-form-label" for="SeoTitle">Seo Başlık</label> *@
            @*         <div class="col-sm-9"> *@
            @*             <input class="form-control input-air-primary" id="SeoTitle" name="SeoTitle" type="text" value=""> *@
            @*             <span class="field-validation-valid" data-valmsg-for="SeoTitle" data-valmsg-replace="true"></span> *@
            @*         </div> *@
            @*     </div> *@
            @*     <div class="form-group row"> *@
            @*         <label class="col-sm-3 col-form-label" for="SeoDescription">Seo Açıklama</label> *@
            @*         <div class="col-sm-9"> *@
            @*             <input class="form-control input-air-primary" id="SeoDescription" name="SeoDescription" type="text" value=""> *@
            @*             <span class="field-validation-valid" data-valmsg-for="SeoDescription" data-valmsg-replace="true"></span> *@
            @*         </div> *@
            @*     </div> *@
            @*     <div class="form-group row"> *@
            @*         <label class="col-sm-3 col-form-label" for="SeoLink">Seo Link</label> *@
            @*         <div class="col-sm-9"> *@
            @*             <input class="form-control input-air-primary" id="SeoLink" name="SeoLink" type="text" value=""> *@
            @*             <span class="field-validation-valid" data-valmsg-for="SeoLink" data-valmsg-replace="true"></span> *@
            @*         </div> *@
            @*     </div> *@
            @* </div> *@
            <div class="card-footer">
                <div class="col-sm-9 offset-sm-3">
                    <button type="submit" class="btn btn-primary"><i class="fa fa-pencil-square-o pr-2"></i>Create</button>
                    <button type="submit" class="btn btn-light ml-2">
                        <i style="color: #7366ff;" class="fa fa-mail-reply pr-2"></i>@Html.ActionLink("No, go back", "Index", new {Id = ViewBag.DbSetName})
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="image-holder-template" class="col-md-3 hidden">
    <a href="#">
        <img class="img-thumbnail" src="#" alt="">
    </a>
    <div class="caption">
        <div class="btn btn-danger mt-10" id="delete-button-template" onclick="deleteFile(this)" data-element="test" data-imgsrc="test">Delete</div>
    </div>
</div>


@section Scripts
{
    <script src="~/_content/Taigate.Crispy/lib/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="~/_content/Taigate.Crispy/lib/codemirror/lib/codemirror.css">
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/xml/xml.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/javascript/javascript.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/css/css.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/xml/xml.js"></script>
    <link rel="stylesheet" href="~/_content/Taigate.Crispy/lib/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="~/_content/Taigate.Crispy/lib/codemirror/addon/hint/show-hint.css">
    <script src="~/_content/Taigate.Crispy/lib/codemirror/lib/codemirror.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/addon/hint/show-hint.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/addon/hint/xml-hint.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/addon/hint/html-hint.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/addon/format/formatting.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/xml/xml.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/javascript/javascript.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/css/css.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="~/_content/Taigate.Crispy/lib/tinymce-dist/tinymce.min.js"></script>

    <script type="text/javascript">
        function deleteFile(thisElem)
        {
            debugger;
            var element = $(thisElem).attr("data-element");
            var imgsrc = $(thisElem).attr("data-imgsrc");
            var imgArr = $(element).val().split(',');
            var index = imgArr.indexOf(imgsrc);
            if (index > -1) {
               imgArr.splice(index, 1);
            } 
            var valueString = imgArr.map((image) => { return image }).join(',');
            $(element).val(valueString);
            $(thisElem).parent().parent().remove();
        }
        function onImageSelected(input,images)
        {
            debugger;
            var imgArr = $(input).val().split(',');
            imgArr = imgArr.filter(function(v){return v!==''});
            imgArr.map((image) => { return images.push( {path : image.substring(1)} ) });
            var valueString = images.map((image) => { return '/'+image.path }).join(',');
            $(input).val('');
            $(input).val(valueString);
            $(input).prop("readonly", "readonly" );
            generateThumbs(input)
        }
        function generateThumbs(input){
            $(input+'_thumb_holder').html('');
           var values = $(input).val().split(',');
           values.map((value) => { 
                 var $template = $('#image-holder-template').clone();
                 $template.removeClass("hidden");
                 $template.find("a").attr("href",value);
                 $template.find("img").attr("src",value);
                 $template.find("#delete-button-template").attr("data-imgsrc",value);
                 $template.find("#delete-button-template").attr("data-element",input);
                 $(input+'_thumb_holder').append($template);
           });
        }
        function closeModal()
        {
            $("#filemanagermodal").modal('hide');
        }
        $(document).ready(function () {
       
            $('.btn-file-manager').click(function (){
                 var id = $(this).attr('data-id');
                 var url = "/crispyadmin/filemanager/browse?element="+id;
                 $.get(url, function (data) {
                      $("#file-manager-modal").html("");     
                      $("#file-manager-modal").append('<iframe src="'+window.location.origin+'/crispyadmin/filemanager/browse?element='+id+'" frameborder="0" style="overflow:hidden;height:100%;width:100%" height="100%" width="100%"></iframe>');
                      $("#filemanagermodal").modal('show');
                 });
            });
            $('.btn-file-remove').click(function (){
                 var id = $(this).attr('data-id');
                 $("#"+id).val(""); 
                 $("#"+id +"_thumb").attr('src','');
            });
        });

    tinymce.init({
        selector: ".textarea", theme: "modern", height: 300,
        plugins: [
                "advlist autolink link image lists charmap print preview hr anchor pagebreak",
                "searchreplace wordcount visualblocks visualchars insertdatetime media nonbreaking",
                "table contextmenu directionality emoticons paste textcolor"
        ],
        toolbar1: "undo redo | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | styleselect",
        toolbar2: "| link unlink anchor | image media | forecolor backcolor  | print preview ",
        image_advtab: true,
        file_picker_callback: elFinderBrowser
    });

    // https://github.com/Studio-42/elFinder/wiki/Integration-with-TinyMCE-4.x
    function elFinderBrowser(callback, value, meta) {
        tinymce.activeEditor.windowManager.open({
            file: '/CrispyAdmin/filemanager/browse',
            title: 'File Manager',
            width: 900,
            height: 450,
            resizable: 'yes'
        }, {
        oninsert: function (file, fm) {
            var url, reg, info;

            // URL normalization
            url = fm.convAbsUrl(file.url);

            // Make file info
            info = file.name + ' (' + fm.formatSize(file.size) + ')';

            // Provide file and text for the link dialog
            if (meta.filetype == 'file') {
                callback(url, { text: info, title: info });
            }

            // Provide image and alt text for the image dialog
            if (meta.filetype == 'image') {
                callback(url, { alt: info });
            }

            // Provide alternative source and posted for the media dialog
            if (meta.filetype == 'media') {
                callback(url);
            }
        }
        });
        return false;
    }
    var element =  document.getElementById("code");
    if (typeof(element) != 'undefined' && element != null)
    {
        window.onload = function() {
              // editor = CodeMirror(document.getElementById("code"), {
              //   mode: "text/html",
              //   extraKeys: {"Ctrl-Space": "autocomplete"},
              //   value: document.documentElement.innerHTML
              // });
              editor = new CodeMirror.fromTextArea(document.getElementById("code"), {
                lineNumbers: true, 
                mode: "text/html", 
                lineWrapping: false,
                     extraKeys:{"Shift-Tab":autoFormatSelection,"Ctrl-Space": "autocomplete"}
              });
              
              
              function getSelectedRange() {
                return { from: editor.getCursor(true), to: editor.getCursor(false) };
              }
              
              function autoFormatSelection() {
                var range = getSelectedRange();
                editor.autoFormatRange(range.from, range.to);
              }
              
              function commentSelection(isComment) {
                var range = getSelectedRange();
                editor.commentRange(isComment, range.from, range.to);
              }  
              editor.setSize(null, 300);
              $('#submitCode').click(function (){
                  $("input[name*='CsHtml']").val(editor.getValue());
              });
              $('#getCode').click(function (){
                  editor.setValue($("input[name*='CsHtml']").val());
                  var totalLines = editor.lineCount();  
                  editor.autoFormatRange({line:0, ch:0}, {line:totalLines});
              });
            };
    }
    
    
    </script>
}